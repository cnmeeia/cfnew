name: Sync and Deploy

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight
  workflow_dispatch: # Allow manual trigger
    inputs:
      force_deploy:
        description: 'Force deploy even if no changes'
        required: false
        default: 'false'

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      deployments: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Sync with Upstream
        id: sync
        run: |
          # --- CONFIGURATION ---
          UPSTREAM_URL="${{ secrets.UPSTREAM_URL }}"
          UPSTREAM_BRANCH="main"
          # ---------------------

          if [ -z "$UPSTREAM_URL" ]; then
            echo "Error: UPSTREAM_URL secret not configured"
            exit 1
          fi

          echo "Adding upstream remote..."
          git remote add upstream "$UPSTREAM_URL" || git remote set-url upstream "$UPSTREAM_URL"
          
          echo "Fetching upstream..."
          git fetch upstream

          echo "Checking for changes..."
          git fetch origin
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/$UPSTREAM_BRANCH)

          if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ] && [ "${{ github.event.inputs.force_deploy }}" != "true" ]; then
            echo "No changes detected. Skipping deployment."
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changes detected. Merging upstream changes..."
          git merge upstream/"$UPSTREAM_BRANCH" --no-edit || {
            echo "Merge conflict detected. Please resolve conflicts manually."
            exit 1
          }

          echo "Pushing changes to origin..."
          git push origin HEAD:${{ github.ref }}

          echo "changes_detected=true" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        if: steps.sync.outputs.changes_detected == 'true' || github.event.inputs.force_deploy == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Generate Wrangler Configuration
        if: steps.sync.outputs.changes_detected == 'true' || github.event.inputs.force_deploy == 'true'
        run: |
          cat > wrangler.toml <<EOF
          name = "cfnew-worker"
          main = "worker.js"
          compatibility_date = "$(date +%Y-%m-%d)"
          
          [vars]
          DEPLOYED_AT = "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          GIT_COMMIT = "${{ github.sha }}"
          EOF

      - name: Prepare Worker Script
        if: steps.sync.outputs.changes_detected == 'true' || github.event.inputs.force_deploy == 'true'
        run: |
          # Try different possible file names
          for file in "少年你相信光吗" "明文源吗" "worker.js" "src/worker.js"; do
            if [ -f "$file" ]; then
              echo "Found worker script: $file"
              cp "$file" worker.js
              echo "worker_source=$file" >> $GITHUB_OUTPUT
              break
            fi
          done

          if [ ! -f "worker.js" ]; then
            echo "Error: No worker script found. Tried: 少年你相信光吗, 明文源吗, worker.js, src/worker.js"
            exit 1
          fi

      - name: Deploy to Cloudflare Workers
        if: steps.sync.outputs.changes_detected == 'true' || github.event.inputs.force_deploy == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Create Deployment Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const deployment = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref: context.ref,
              auto_merge: false,
              required_contexts: [],
              environment: 'production'
            });
            
            const deployment_id = deployment.data.id;
            
            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id,
              state: '${{ job.status }}' === 'success' ? 'success' : 'failure',
              environment_url: 'https://cfnew-worker.YOUR_SUBDOMAIN.workers.dev'
            });
